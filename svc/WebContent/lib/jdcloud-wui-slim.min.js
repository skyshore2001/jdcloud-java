// jdcloud-wui-slim version 1.1

jdModule("jdcloud.common",JdcloudCommon);function JdcloudCommon()
{var self=this;self.assert=assert;function assert(cond,dscr)
{if(!cond){var msg="!!! assert fail!";if(dscr)
msg+=" - "+dscr;throw new Error(msg);}}
self.randInt=randInt;function randInt(from,to)
{return Math.floor(Math.random()*(to-from+1))+from;}
self.randChr=randChr;function randChr(cnt)
{var charCodeArr=[];var code_O='O'.charCodeAt(0)-'A'.charCodeAt(0)+10;for(var i=0;i<cnt;){var ch=randInt(0,35);if(ch==0||ch==code_O){continue;}
if(ch<10){charCodeArr.push(0x30+ch);}
else{charCodeArr.push(0x41+ch-10);}
i++;}
return String.fromCharCode.apply(this,charCodeArr);}
self.parseQuery=parseQuery;function parseQuery(s)
{var ret={};if(s!="")
{var a=s.split('&')
for(i=0;i<a.length;++i){var a1=a[i].split("=");var val=a1[1];if(val===undefined)
val=1;else if(/^-?[0-9]+$/.test(val)){val=parseInt(val);}
else if(/^-?[0-9.]+$/.test(val)){val=parseFloat(val);}
else{val=decodeURIComponent(val);}
ret[a1[0]]=val;}}
return ret;}
self.tobool=tobool;function tobool(v)
{if(typeof v==="string")
return v!==""&&v!=="0"&&v.toLowerCase()!=="false"&&v.toLowerCase()!=="off";return!!v;}
self.reloadSite=reloadSite;function reloadSite()
{var href=location.href.replace(/#.+/,'#');history.replaceState(null,null,href);location.reload();throw"abort";}
function setWidth_2(number)
{return number<10?("0"+number):(""+number);}
Date.prototype.format=function(fmt)
{if(fmt==null)
fmt="L";switch(fmt){case"L":fmt="yyyy-mm-dd HH:MM:SS";break;case"D":fmt="yyyy-mm-dd";break;case"T":fmt="HH:MM:SS";break;}
var year=this.getFullYear();return fmt.replace("yyyy",year).replace("yy",(""+year).substring(2)).replace("mm",setWidth_2(this.getMonth()+1)).replace("dd",setWidth_2(this.getDate())).replace("HH",setWidth_2(this.getHours())).replace("MM",setWidth_2(this.getMinutes())).replace("SS",setWidth_2(this.getSeconds()));}
Date.prototype.addDay=function(iDay)
{this.setDate(this.getDate()+iDay);return this;}
Date.prototype.addHours=function(iHours)
{this.setHours(this.getHours()+iHours);return this;}
Date.prototype.addMin=function(iMin)
{this.setMinutes(this.getMinutes()+iMin);return this;}
Date.prototype.addMonth=function(iMonth)
{this.setMonth(this.getMonth()+iMonth);return this;}
self.parseTime=parseTime;function parseTime(s)
{var a=s.split(":");var dt=new Date(0,0,1,a[0],a[1]||0,a[2]||0);if(isNaN(dt.getYear()))
return null;return dt;}
self.parseDate=parseDate;function parseDate(str)
{if(str==null)
return null;if(str instanceof Date)
return str;if(/Z$/.test(str)){return new Date(str);}
var ms=str.match(/^(\d+)(?:[-\/.](\d+)(?:[-\/.](\d+))?)?/);if(ms==null)
return null;var y,m,d;var now=new Date();if(ms[3]!==undefined){y=parseInt(ms[1]);m=parseInt(ms[2])-1;d=parseInt(ms[3]);if(y<100)
y+=2000;}
else if(ms[2]!==undefined){y=now.getFullYear();m=parseInt(ms[1])-1;d=parseInt(ms[2]);}
else{y=now.getFullYear();m=now.getMonth();d=parseInt(ms[1]);}
var h,n,s;h=0;n=0;s=0;ms=str.match(/(\d+):(\d+)(?::(\d+))?/);if(ms!=null){h=parseInt(ms[1]);n=parseInt(ms[2]);if(ms[3]!==undefined)
s=parseInt(ms[3]);}
var dt=new Date(y,m,d,h,n,s);if(isNaN(dt.getYear()))
return null;ms=str.match(/:[0-9.T]+([+-])(\d{1,4})$/);if(ms!=null){var sign=(ms[1]=="-"?-1:1);var cnt=ms[2].length;var n=parseInt(ms[2].replace(/^0+/,''));if(isNaN(n))
n=0;else if(cnt>2)
n=Math.floor(n/100);var tzOffset=sign*n*60+dt.getTimezoneOffset();if(tzOffset)
dt.addMin(-tzOffset);}
return dt;}
Date.prototype.add=function(sInterval,n)
{switch(sInterval){case'd':this.setDate(this.getDate()+n);break;case'm':this.setMonth(this.getMonth()+n);break;case'y':this.setFullYear(this.getFullYear()+n);break;case'h':this.setHours(this.getHours()+n);break;case'n':this.setMinutes(this.getMinutes()+n);break;case's':this.setSeconds(this.getSeconds()+n);break;}
return this;}
Date.prototype.diff=function(sInterval,dtEnd)
{var dtStart=this;switch(sInterval)
{case'd':{var d1=(dtStart.getTime()-dtStart.getTimezoneOffset()*60000)/86400000;var d2=(dtEnd.getTime()-dtEnd.getTimezoneOffset()*60000)/86400000;return Math.floor(d2)-Math.floor(d1);}
case'm':return dtEnd.getMonth()-dtStart.getMonth()+(dtEnd.getFullYear()-dtStart.getFullYear())*12;case'y':return dtEnd.getFullYear()-dtStart.getFullYear();case's':return Math.round((dtEnd-dtStart)/1000);case'n':return Math.round((dtEnd-dtStart)/60000);case'h':return Math.round((dtEnd-dtStart)/3600000);}}
self.getTimeDiffDscr=getTimeDiffDscr;function getTimeDiffDscr(tm,tm1)
{if(!tm||!tm1)
return"";if(!(tm instanceof Date)){tm=parseDate(tm);}
if(!(tm1 instanceof Date)){tm1=parseDate(tm1);}
var diff=(tm1-tm)/1000;if(diff<60){return"刚刚";}
diff/=60;if(diff<60){return Math.floor(diff)+"分钟前";}
diff/=60;if(diff<48){return Math.floor(diff)+"小时前";}
diff/=24;if(diff<365*2)
return Math.floor(diff)+"天前";diff/=365;if(diff<10)
return Math.floor(diff)+"年前";return"很久前";}
self.getTmRange=getTmRange;function getTmRange(dscr,now)
{if(!now)
now=new Date();else if(!(now instanceof Date)){now=WUI.parseDate(now);}
else{now=new Date(now);}
var rv=getTmRangeSimple(dscr,now);if(rv)
return rv;dscr=dscr.replace(/本|今/,"前0");dscr=dscr.replace(/上|昨/,"前");var re=/(近|前)(\d*).*?(小时|日|天|月|周|年)/;var m=dscr.match(re);if(!m)
return;var dt1,dt2,dt;var type=m[1];var n=parseInt(m[2]||'1');var u=m[3];var fmt_d="yyyy-mm-dd";var fmt_h="yyyy-mm-dd HH:00";var fmt_m="yyyy-mm-01";var fmt_y="yyyy-01-01";if(u=="小时"){if(n==0){now.add("h",1);n=1;}
if(type=="近"){now.add("h",1);}
dt2=now.format(fmt_h);dt1=now.add("h",-n).format(fmt_h);}
else if(u=="日"||u=="天"){if(n==0||type=="近"){now.addDay(1);++n;}
dt2=now.format(fmt_d);dt1=now.add("d",-n).format(fmt_d);}
else if(u=="月"){if(n==0){now.addMonth(1);n=1;}
if(type=="近"){now.addDay(1);var d2=now.getDate();dt2=now.format(fmt_d);now.add("m",-n);do{var d1=now.getDate();if(d1==d2||d1>10)
break;now.addDay(-1);}while(true);dt1=now.format(fmt_d);}
else if(type=="前"){dt2=now.format(fmt_m);dt1=WUI.parseDate(dt2).add("m",-n).format(fmt_m);}}
else if(u=="周"){if(n==0){now.addDay(7);n=1;}
if(type=="近"){now.addDay(1);dt2=now.format(fmt_d);dt1=now.add("d",-n*7).format(fmt_d);}
else if(type=="前"){dt2=now.add("d",-now.getDay()+1).format(fmt_d);dt1=now.add("d",-7*n).format(fmt_d);}}
else if(u=="年"){if(n==0){now.add("y",1);n=1;}
if(type=="近"){now.addDay(1);dt2=now.format(fmt_d);dt1=now.add("y",-n).format(fmt_d);}
else if(type=="前"){dt2=now.format(fmt_y);dt1=WUI.parseDate(dt2).add("y",-n).format(fmt_y);}}
else{return;}
return[dt1,dt2];}
function getTmRangeSimple(dscr,now)
{var fmt_d="yyyy-mm-dd";var fmt_m="yyyy-mm-01";var fmt_y="yyyy-01-01";if(dscr=="本月"){var dt1=now.format(fmt_m);var y=now.getFullYear();var m=now.getMonth()+2;if(m==12){++y;m=1;}
var dt2=y+"-"+setWidth_2(m)+"-01";}
else if(dscr=="上月"){var dt2=now.format(fmt_m);var y=now.getFullYear();var m=now.getMonth();now.addMonth(-1);if(m==0){--y;m=12;}
var dt1=y+"-"+setWidth_2(m)+"-01";}
else if(dscr=="本周"){var dt1=now.add("d",-(now.getDay()||7)+1).format(fmt_d);now.addDay(7);var dt2=now.format(fmt_d);}
else if(dscr=="上周"){var dt2=now.add("d",-(now.getDay()||7)+1).format(fmt_d);now.addDay(-7);var dt1=now.format(fmt_d);}
else if(dscr=="今年"){var dt1=now.format(fmt_y);now.addMonth(12);var dt2=now.format(fmt_y);}
else if(dscr=="去年"||dscr=="上年"){var dt2=now.format(fmt_y);now.addMonth(-12);var dt1=now.format(fmt_y);}
else if(dscr=="本季度"){var m=Math.floor(now.getMonth()/3)*3+1;var dt1=now.getFullYear()+"-"+setWidth_2(m)+"-01";var dt2=now.getFullYear()+"-"+setWidth_2(m+3)+"-01";}
else if(dscr=="上季度"){var m=Math.floor(now.getMonth()/3)*3;if(m>0){var dt1=now.getFullYear()+"-"+setWidth_2(m-3)+"-01";var dt2=now.getFullYear()+"-"+setWidth_2(m)+"-01";}
else{var y=now.getFullYear();var dt1=(y-1)+"-10-01";var dt2=y+"-01-01";}}
else if(dscr=="上半年"){var y=now.getFullYear();var dt1=y+"-01-01";var dt2=y+"-07-01";}
else if(dscr=="下半年"){var y=now.getFullYear();var dt1=y+"-07-01";var dt2=(y+1)+"-01-01";}
else{return;}
return[dt1,dt2];}
self.setCookie=setCookie;function setCookie(name,value,days)
{if(days===undefined)
days=30;if(value==null)
{days=-1;value="";}
var exp=new Date();exp.setTime(exp.getTime()+days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString();}
self.getCookie=getCookie;function getCookie(name)
{var m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(m!=null){return(unescape(m[2]));}else{return null;}}
self.delCookie=delCookie;function delCookie(name)
{if(getCookie(name)!=null){setCookie(name,null,-1);}}
self.setStorage=setStorage;function setStorage(name,value,useSession)
{if($.isPlainObject(value)||$.isArray(value)){value=JSON.stringify(value);}
assert(typeof value!="object","value must be scalar!");if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;if(useSession)
sessionStorage.setItem(name,value);else
localStorage.setItem(name,value);}
self.getStorage=getStorage;function getStorage(name,useSession)
{if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;var value;if(useSession)
value=sessionStorage.getItem(name);else
value=localStorage.getItem(name);if(typeof(value)=="string"&&(value[0]=='{'||value[0]=='['))
value=JSON.parse(value);return value;}
self.delStorage=delStorage;function delStorage(name,useSession)
{if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;if(useSession)
sessionStorage.removeItem(name);else
localStorage.removeItem(name);}
self.rs2Array=rs2Array;function rs2Array(rs)
{var ret=[];var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret.push(obj);}
return ret;}
self.rs2Hash=rs2Hash;function rs2Hash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];if(Array.isArray(k)&&k.length==2)
ret[k[0]]=k[1];else
ret[k]=obj;}
return ret;}
self.rs2MultiHash=rs2MultiHash;function rs2MultiHash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];if(Array.isArray(k)&&k.length==2){obj=k[1];k=k[0];}
if(ret[k]===undefined)
ret[k]=[obj];else
ret[k].push(obj);}
return ret;}
self.list2varr=list2varr;function list2varr(ls,sep,sep2)
{if(sep==null)
sep=':';if(sep2==null)
sep2=',';var ret=[];$.each(ls.split(sep2),function(){if(this.length==0)
return;ret.push(this.split(sep));});return ret;}
self.objarr2list=objarr2list;function objarr2list(objarr,fields,sep,sep2)
{sep=sep||':';sep2=sep2||',';var fn=$.isFunction(fields)?fields:function(e,i){var row='';$.each(fields,function(j,e1){if(row.length>0)
row+=sep;row+=e[e1];});return row;};return $.map(objarr,fn).join(sep2);}
self.intSort=intSort;function intSort(a,b)
{return parseInt(a)-parseInt(b);}
self.numberSort=numberSort;function numberSort(a,b)
{return parseFloat(a)-parseFloat(b);}
self.getAncestor=getAncestor;function getAncestor(o,fn)
{while(o){if(fn(o))
return o;o=o.parentElement;}
return o;}
self.appendParam=appendParam;function appendParam(url,param)
{if(param==null)
return url;var ret;var a=url.split("#");ret=a[0]+(url.indexOf('?')>=0?"&":"?")+param;if(a.length>1){ret+="#"+a[1];}
return ret;}
self.deleteParam=deleteParam;function deleteParam(url,paramName)
{var ret=url.replace(new RegExp('&?\\b'+paramName+"\\b(=[^&#]+)?"),'');ret=ret.replace(/\?&/,'?');return ret;}
self.isWeixin=isWeixin;function isWeixin()
{return/micromessenger/i.test(navigator.userAgent);}
self.isIOS=isIOS;function isIOS()
{return/iPhone|iPad/i.test(navigator.userAgent);}
self.isAndroid=isAndroid;function isAndroid()
{return/Android/i.test(navigator.userAgent);}
self.parseValue=parseValue;function parseValue(str)
{if(str==null)
return str;var val=str;if(/^-?[0-9]+$/.test(str)){val=parseInt(str);}
if(/^-?[0-9.]+$/.test(str)){val=parseFloat(str);}
return val;}
self.applyTpl=applyTpl;function applyTpl(tpl,data)
{return tpl.replace(/{([^{}]+)}/g,function(m0,m1){return data[m1];});}
self.delayDo=delayDo;function delayDo(fn,delayCnt)
{if(delayCnt==null)
delayCnt=3;doIt();function doIt()
{if(delayCnt==0)
{fn();return;}
--delayCnt;setTimeout(doIt);}}
self.kvList2Str=kvList2Str;function kvList2Str(kv,sep,sep2)
{var ret='';$.each(kv,function(k,v){if(typeof(v)!="function"){if(ret)
ret+=sep;ret+=k+sep2+v;}});return ret;}
self.parseKvList=parseKvList;function parseKvList(str,sep,sep2)
{var map={};$.each(str.split(sep),function(i,e){var kv=e.split(sep2,2);if(kv.length<2){kv[1]=kv[0];}
map[kv[0]]=kv[1];});return map;}
window.Q=self.Q=Q;function Q(str,q)
{if(str==null)
return"null";if(typeof str=="number")
return str;if(q==null)
q="'";return q+str.toString().replaceAll(q,"\\"+q)+q;}
function initModule()
{if(String.prototype.startsWith==null){String.prototype.startsWith=function(s){return this.substr(0,s.length)==s;}}
if(window.console===undefined){window.console={log:function(){}}}}
initModule();self.text2html=text2html;function text2html(s,pics)
{var ret="";if(s){ret=s.replace(/^(?:([#-]+)\s+)?(.*)$/mg,function(m,begin,text){if(begin){if(begin[0]=='#'){n=begin.length;return"<h"+n+">"+text+"</h"+n+">";}
if(begin[0]=='-'){return"<li>"+text+"</li>";}}
if(text){text=text.replace(" ","&nbsp;");}
else{text="&nbsp;";}
return"<p>"+text+"</p>";})+"\n";}
if(pics){var arr=pics.split(/\s*,\s*/);arr.forEach(function(e){var url="../api.php/att?thumbId="+e;ret+="<img src=\""+url+"\">\n";});}
return ret;}}
function jdModule(name,fn,overrideCtor)
{if(!window.jdModuleMap){window.jdModuleMap={};}
if(name==null){return window.jdModuleMap;}
var ret;if(typeof(fn)==="function"){if(window.jdModuleMap[name]){fn.call(window.jdModuleMap[name]);}
else{window.jdModuleMap[name]=new fn();}
ret=window.jdModuleMap[name];if(overrideCtor)
ret.constructor=fn;}
else{ret=window.jdModuleMap[name];if(!ret){throw"load module fails: "+name;}}
return ret;}
if(!String.prototype.replaceAll){String.prototype.replaceAll=function(from,to){return this.replace(new RegExp(from,"g"),to);}}
jdModule("jdcloud.common",JdcloudCommonJq);function JdcloudCommonJq()
{var self=this;self.assert(window.jQuery,"require jquery lib.");var mCommon=jdModule("jdcloud.common");self.getFormData=getFormData;function getFormData(jo)
{var data={};var isFormData=false;var enctype=jo.attr("enctype");if((enctype&&enctype.toLowerCase()=="multipart/form-data")||jo.has("[name]:file").size()>0){isFormData=true;data=new FormData();}
var orgData=jo.data("origin_")||{};formItems(jo,function(ji,name,it){if(it.getDisabled(ji))
return;var orgContent=orgData[name];if(orgContent==null)
orgContent="";var content=it.getValue(ji);if(content==null)
content="";if(content!==String(orgContent))
{if(!isFormData){if(name.substr(-2)=="[]"){name=name.substr(0,name.length-2);if(!data[name]){data[name]=[];}
data[name].push(content);}
else{data[name]=content;}}
else{if(ji.is(":file")){$.each(ji.prop("files"),function(i,e){data.append(name,e);});}
else{data.append(name,content);}}}});return data;}
self.getFormData_vf=getFormData_vf;function getFormData_vf(jo)
{var data={};formItems(jo,function(ji,name,it){var vname=WUI.getOptions(ji).jd_vField;if(!vname)
return;data[vname]=it.getValue_vf(ji);});return data;}
self.formItems=formItems;self.formItems["[name]"]=self.defaultFormItems={getName:function(jo){if(jo.hasClass("textbox-value"))
return;return jo.attr("name")||jo.prop("name");},getDisabled:function(jo){var val=jo.prop("disabled");if(val===undefined)
val=jo.attr("disabled");var o=jo[0];if(!val&&o.tagName=="INPUT"){if(o.type=="radio"&&!o.checked)
return true;}
return val;},setDisabled:function(jo,val){jo.prop("disabled",!!val);if(val)
jo.attr("disabled","disabled");else
jo.removeAttr("disabled");},getReadonly:function(jo){var val=jo.prop("readonly");if(val===undefined)
val=jo.attr("readonly");return val;},setReadonly:function(jo,val){jo.prop("readonly",!!val);if(val)
jo.attr("readonly","readonly");else
jo.removeAttr("readonly");},setValue:function(jo,val){var isInput=jo.is(":input");if(val===undefined){if(isInput){var o=jo[0];if(o.tagName==="TEXTAREA")
val=jo.html();else if(!(o.tagName=="INPUT")&&(o.type=="hidden"))
val=jo.attr("value");if(val===undefined)
val="";}
else{val="";}}
if(jo.is(":checkbox")){jo.prop("checked",mCommon.tobool(val));}
else if(isInput){jo.val(val);}
else{jo.html(val);}},getValue:function(jo){var val;if(jo.is(":checkbox")){val=jo.prop("checked")?jo.val():jo.attr("value-off");}
else if(jo.is(":input")){val=jo.val();}
else{val=jo.html();}
return val;},getShowbox:function(jo){return jo;},getValue_vf:function(jo){var o=jo[0];if(o.tagName=="SELECT")
return o.options[o.selectedIndex].innerText;return this.getValue(jo);}};function formItems(jo,cb)
{var doBreak=false;$.each(self.formItems,function(sel,it){jo.filter(sel).add(jo.find(sel)).each(function(){var ji=$(this);var name=it.getName(ji);if(!name)
return;if(cb(ji,name,it)===false){doBreak=true;return false;}});if(doBreak)
return false;});return!doBreak;}
self.setFormData=setFormData;function setFormData(jo,data,opt)
{var opt1=$.extend({setOrigin:false},opt);if(data==null)
data={};formItems(jo,function(ji,name,it){if(ji.attr("noReset"))
return;var content=data[name];if(opt1.setOnlyDefined&&content===undefined)
return;it.setValue(ji,content);});jo.data("origin_",opt1.setOrigin?data:null);}
self.loadScript=loadScript;function loadScript(url,fnOK,options)
{if($.isPlainObject(fnOK)){options=fnOK;fnOK=null;}
if(options){var ajaxOpt=$.extend({dataType:"script",cache:true,success:fnOK,url:url,error:function(xhr,textStatus,err){console.log("*** loadScript fails for "+url);console.log(err);}},options);return jQuery.ajax(ajaxOpt);}
var dfd_=$.Deferred();var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onload=function(){if(fnOK)
fnOK();dfd_.resolve();}
script.onerror=function(){dfd_.reject();console.log("*** loadScript fails for "+url);}
document.head.appendChild(script);return dfd_;}
self.loadJson=loadJson;function loadJson(url,fnOK,options)
{var ajaxOpt=$.extend({dataType:"text",jdFilter:false,success:function(data){val=eval("("+data+")");fnOK.call(this,val);}},options);return $.ajax(url,ajaxOpt);}
self.loadCss=loadCss;function loadCss(url)
{var jo=$('<link type="text/css" rel="stylesheet" />').attr("href",url);jo.appendTo($("head"));}
self.setDateBox=setDateBox;function setDateBox(jo,defDateFn)
{jo.blur(function(){var dt=self.parseDate(this.value);if(dt==null){if(defDateFn)
dt=defDateFn();else
dt=new Date();}
this.value=dt.format("D");});}
self.setTimeBox=setTimeBox;function setTimeBox(jo,defTimeFn)
{jo.blur(function(){var dt=self.parseTime(this.value);if(dt==null){if(defTimeFn)
dt=defTimeFn();else
dt=new Date();}
this.value=dt.format("HH:MM");});}
self.waitFor=waitFor;function waitFor(dfd)
{if(waitFor.caller==null)
throw"waitFor MUST be called in function!";if(dfd.state()=="resolved")
return false;if(!dfd.isset_)
{var caller=waitFor.caller;var args=caller.arguments;dfd.isset_=true;dfd.then(function(){caller.apply(this,args);});}
return true;}
self.rgb=rgb;function rgb(r,g,b,a)
{if(a===0)
return;return'#'+pad16(r)+pad16(g)+pad16(b);function pad16(n){var ret=n.toString(16);return n>16?ret:'0'+ret;}}
self.rgb2hex=rgb2hex;function rgb2hex(rgbFormat)
{var rgba=rgb;try{return eval(rgbFormat);}catch(ex){console.log(ex);}}
$.fn.jdata=function(val){if(val!=null){this.data("jdata",val);return val;}
var jd=this.data("jdata");if(jd==null)
jd=this.jdata({});return jd;}
self.compressImg=compressImg;function compressImg(fileObj,cb,opt)
{var opt0={quality:0.8,maxSize:1280,mimeType:"image/jpeg"};opt=$.extend(opt0,opt);window.BlobBuilder=(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);var doDowngrade=!window.Blob||window.BlobBuilder;if(doDowngrade){var rv={name:fileObj.name,size:fileObj.size,b64src:window.URL.createObjectURL(fileObj),blob:fileObj,};rv.info="compress ignored. "+rv.name+": "+(rv.size/1024).toFixed(0)+"KB";console.log(rv.info);cb(rv);return;}
var img=new Image();img.src=window.URL.createObjectURL(fileObj);img.onload=function(){var rv=resizeImg(img);rv.info="compress "+rv.name+" q="+rv.quality+": "+rv.w0+"x"+rv.h0+"->"+rv.w+"x"+rv.h+", "+(rv.size0/1024).toFixed(0)+"KB->"+(rv.size/1024).toFixed(0)+"KB(rate="+(rv.size/rv.size0*100).toFixed(2)+"%,b64="+(rv.b64size/1024).toFixed(0)+"KB)";console.log(rv.info);cb(rv);}
function resizeImg()
{var w=img.naturalWidth,h=img.naturalHeight;if(opt.maxSize<w||opt.maxSize<h){if(w>h){h=Math.round(h*opt.maxSize/w);w=opt.maxSize;}
else{w=Math.round(w*opt.maxSize/h);h=opt.maxSize;}}
var cvs=document.createElement('canvas');cvs.width=w;cvs.height=h;var ctx=cvs.getContext("2d").drawImage(img,0,0,w,h);var b64src=cvs.toDataURL(opt.mimeType,opt.quality);var blob=getBlob(b64src);if(blob.size>fileObj.size){blob=fileObj;opt.mimeType=fileObj.type;}
var fname=getFname(fileObj.name,opt.mimeType);return{w0:img.naturalWidth,h0:img.naturalHeight,w:w,h:h,quality:opt.quality,mimeType:opt.mimeType,b64src:b64src,name:fname,blob:blob,size0:fileObj.size,b64size:b64src.length,size:blob.size};}
function getBlob(b64src)
{var bytes=window.atob(b64src.split(',')[1]);var ia=new Uint8Array(bytes.length);for(var i=0;i<bytes.length;i++){ia[i]=bytes.charCodeAt(i);}
var blob;try{blob=new Blob([ia.buffer],{type:opt.mimeType});}
catch(e){if(e.name=='TypeError'&&window.BlobBuilder){var bb=new BlobBuilder();bb.append(ia.buffer);blob=bb.getBlob(opt.mimeType);}
else{}}
return blob;}
function getFname(fname,mimeType)
{var exts={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"};var ext1=exts[mimeType];if(ext1==null)
return fname;return fname.replace(/(\.\w+)?$/,ext1);}}
self.getDataOptions=getDataOptions;function getDataOptions(jo,defVal)
{var optStr=jo.attr("data-options");var opts;try{if(optStr!=null){if(/^\w+:/.test(optStr)){opts=eval("({"+optStr+"})");}
else{opts=eval("("+optStr+")");}}}catch(e){alert("bad data-options: "+optStr);}
return $.extend({},defVal,opts);}
self.triggerAsync=triggerAsync;function triggerAsync(jo,ev,paramArr)
{if(typeof(ev)=="string"){ev=$.Event(ev);}
ev.dfds=[];jo.trigger(ev,paramArr);if(ev.isDefaultPrevented())
return false;return $.when.apply(this,ev.dfds);}
var fnDeferred=$.Deferred;$.Deferred=function(){var ret=fnDeferred.apply(this,arguments);ret.catch=ret.fail;ret.finally=ret.always;var fn=ret.promise;ret.promise=function(){var r=fn.apply(this,arguments);r.catch=r.fail;r.finally=r.always;return r;}
return ret;}}
function JdcloudApp()
{var self=this;self.ctx=self.ctx||{};window.E_AUTHFAIL=-1;window.E_NOAUTH=2;window.E_ABORT=-100;self.evalAttr=evalAttr;function evalAttr(jo,name,ctx)
{var val=jo.attr(name);if(val){if(val[0]!='{'&&val.indexOf(":")>0){val1="({"+val+"})";}
else{val1="("+val+")";}
try{val=eval(val1);}
catch(ex){self.app_alert("属性`"+name+"'格式错误: "+val,"e");val=null;}}
return val;}
self.ctx.fixPageCss=fixPageCss;function fixPageCss(css,selector)
{var prefix=selector+" ";var level=1;var css1=css.replace(/\/\*(.|\s)*?\*\//g,'').replace(/([^{}]*)([{}])/g,function(ms,text,brace){if(brace=='}'){--level;return ms;}
if(brace=='{'&&level++!=1)
return ms;return ms.replace(/((?:^|,)\s*)([^,{}]+)/g,function(ms,ms1,sel){if(sel.startsWith(prefix)||sel[0]=='@')
return ms;return ms1+prefix+sel;});});return css1;}
self.app_abort=app_abort;function app_abort()
{throw new DirectReturn();}
window.DirectReturn=DirectReturn;function DirectReturn(){}
self.setOnError=setOnError;function setOnError()
{var fn=window.onerror;window.onerror=function(msg,script,line,col,errObj){if(fn&&fn.apply(this,arguments)===true)
return true;if(errObj instanceof DirectReturn||/abort$/.test(msg)||(!script&&!line))
return true;if(self.options.skipErrorRegex&&self.options.skipErrorRegex.test(msg))
return true;if(errObj===undefined&&msg==="[object Object]")
return true;debugger;var content=msg+" ("+script+":"+line+":"+col+")";if(errObj&&errObj.stack)
content+="\n"+errObj.stack.toString();if(self.syslog)
self.syslog("fw","ERR",content);app_alert(msg,"e");setTimeout(function(){$.active=0;self.isBusy=0;self.hideLoading();},1000);}}
setOnError();self.m_enhanceFn={};self.enhanceWithin=enhanceWithin;function enhanceWithin(jp)
{$.each(self.m_enhanceFn,function(sel,fn){var jo=jp.find(sel);if(jp.is(sel))
jo=jo.add(jp);if(jo.size()==0)
return;jo.each(function(i,e){var je=$(e);var enhanced=je.data("mui-enhanced");if(enhanced){if(enhanced.indexOf(sel)>=0)
return;enhanced.push(sel);}
else{enhanced=[sel];}
je.data("mui-enhanced",enhanced);fn(je);});});}
self.getOptions=getOptions;function getOptions(jo,defVal)
{var opt=jo.prop("muiOptions");if(opt===undefined){opt=self.getDataOptions(jo,defVal);jo.prop("muiOptions",opt);}
return opt;}
function getexp(k,v)
{if(typeof(v)=="number")
return k+"="+v;var op="=";var is_like=false;var ms;if(ms=v.match(/^(<>|>=?|<=?|!=?)/)){op=ms[1];v=v.substr(op.length);if(op=="!"||op=="!=")
op="<>";}
else if(v.indexOf("*")>=0||v.indexOf("%")>=0){v=v.replace(/[*]/g,"%");op=" like ";}
v=$.trim(v);if(v==="null")
{if(op=="<>")
return k+" is not null";return k+" is null";}
if(v==="empty")
v="";var doFuzzy=self.options.fuzzyMatch&&(k!="id"&&k.substr(-2)!="Id");if(doFuzzy||v.length==0||v.match(/\D/)||v[0]=='0'){v=v.replace(/'/g,"\\'");if(doFuzzy&&op=="="&&v.length>0){op=" like ";v="%"+v+"%";}
return k+op+"'"+v+"'";}
return k+op+v;}
self.queryHint="查询示例\n"+"文本：\"王小明\", \"王*\"(匹配开头), \"*上海*\"(匹配部分)\n"+"数字：\"5\", \">5\", \"5-10\", \"5-10,12,18\"\n"+"时间：\">=2017-10-1\", \"<2017-10-1 18:00\", \"2017-10\"(10月份区间), \"2017-10-01~2017-11-01\"(10月份区间)\n"+"高级：\"!5\"(排除5),\"1-10 and !5\", \"王*,张*\"(王某或张某), \"empty\"(为空), \"0,null\"(0或未设置)\n";self.getQueryCond=getQueryCond;function getQueryCond(kvList)
{var condArr=[];if($.isPlainObject(kvList)){$.each(kvList,handleOne);}
else if($.isArray(kvList)){$.each(kvList,function(i,e){handleOne(e[0],e[1]);});}
function handleOne(k,v){if(v==null||v===""||v.length==0)
return;var hint=null;var k1=k.split('/');if(k1.length>1){k=k1[0];hint=k1[1];}
if($.isArray(v)){if(v[0])
condArr.push(k+">='"+v[0]+"'");if(v[1])
condArr.push(k+"<'"+v[1]+"'");return;}
var hint=null;var k1=k.split('/');if(k1.length>1){k=k1[0];hint=k1[1];}
if($.isArray(v)){if(v[0])
condArr.push(k+">='"+v[0]+"'");if(v[1])
condArr.push(k+"<'"+v[1]+"'");return;}
var arr=v.toString().split(/\s+(and|or)\s+/i);var str='';var bracket=false;var isTm=hint=="tm"||/(Tm|^tm)\d*$/.test(k);var isDt=hint=="dt"||/(Dt|^dt)\d*$/.test(k);$.each(arr,function(i,v1){if((i%2)==1){str+=' '+v1.toUpperCase()+' ';bracket=true;return;}
v1=v1.replace(/，/g,',');v1=v1.replace(/＊/g,'*');var str1='';var bracket2=false;$.each(v1.split(/\s*,\s*/),function(j,v2){if(str1.length>0){str1+=" OR ";bracket2=true;}
var mt;var isHandled=false;if(hint!="s"&&(isTm||isDt)){if(mt=v2.match(/^(\d{4})-(\d{1,2})(?:-(\d{1,2}))?$/)){var y=parseInt(mt[1]),m=parseInt(mt[2]),d=mt[3]!=null?parseInt(mt[3]):null;if((y>1900&&y<2100)&&(m>=1&&m<=12)&&(d==null||(d>=1&&d<=31&&isTm))){isHandled=true;var dt1,dt2;if(d){var dt=new Date(y,m-1,d);dt1=dt.format("D");dt2=dt.addDay(1).format("D");}
else{var dt=new Date(y,m-1,1);dt1=dt.format("D");dt2=dt.addMonth(1).format("D");}
str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";}}}
if(!isHandled&&hint!="s"){if(mt=v2.match(/^(\d{4}-\d{1,2}.*?)\s*~\s*(\d{4}-\d{1,2}.*?)$/)){var dt1=mt[1],dt2=mt[2];str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";isHandled=true;}
else if(mt=v2.match(/^(\d+)-(\d+)$/)){var a=parseInt(mt[1]),b=parseInt(mt[2]);if(a<b){str1+="("+k+">="+mt[1]+" AND "+k+"<="+mt[2]+")";isHandled=true;}}}
if(!isHandled){str1+=getexp(k,v2);}});if(bracket2)
str+="("+str1+")";else
str+=str1;});if(bracket)
str='('+str+')';condArr.push(str);}
return condArr.join(' AND ');}
self.getQueryParam=getQueryParam;function getQueryParam(kvList)
{var ret={};var cond=getQueryCond(kvList);if(cond)
ret.cond=cond;return ret;}
self.doSpecial=doSpecial;function doSpecial(jo,filter,fn,cnt,interval)
{var MAX_CNT=cnt||5;var INTERVAL=interval||2;jo.on("click.special",filter,function(ev){var tm=new Date();var obj=this;if(fn.cnt==null||fn.lastTm==null||tm-fn.lastTm>INTERVAL*1000||fn.lastObj!=obj)
{fn.cnt=0;fn.lastTm=tm;fn.lastObj=obj;}
if(++fn.cnt<MAX_CNT)
return;fn.cnt=0;fn.lastTm=tm;fn.call(this,ev);});}}
function JdcloudCall()
{var self=this;var mCommon=jdModule("jdcloud.common");self.lastError=null;var m_tmBusy;var m_manualBusy=0;var m_appVer;var m_silentCall=0;self.disableBatch=false;var m_curBatch=null;self.m_curBatch=m_curBatch;var RV_ABORT=undefined;self.mockData={};var ajaxOpt={beforeSend:function(xhr){this.xhr_=xhr;var type=this.dataType;if(this.jdFilter!==false&&(type=="json"||type=="text")){this.jdFilter=true;this.converters["text json"]=true;}},dataFilter:function(data,type){if(this.jdFilter){rv=defDataProc.call(this,data);if(rv!==RV_ABORT)
return rv;--$.active;self.app_abort();}
return data;},error:defAjaxErrProc};if(location.protocol=="file:"){ajaxOpt.xhrFields={withCredentials:true};}
$.ajaxSetup(ajaxOpt);self.enterWaiting=enterWaiting;function enterWaiting(ctx)
{if(ctx&&ctx.noLoadingImg){++m_silentCall;return;}
if(self.isBusy==0){m_tmBusy=new Date();}
self.isBusy=1;if(ctx==null||ctx.isMock)
++m_manualBusy;setTimeout(function(){if(self.isBusy)
self.showLoading();},(self.options.showLoadingDelay||200));}
self.leaveWaiting=leaveWaiting;function leaveWaiting(ctx)
{if(ctx==null||ctx.isMock)
{if(--m_manualBusy<0)
m_manualBusy=0;}
mCommon.delayDo(function(){if(self.options.logAction&&ctx&&ctx.ac&&ctx.tv){var tv2=(new Date()-ctx.tm)-ctx.tv;ctx.tv2=tv2;console.log(ctx);}
if(ctx&&ctx.noLoadingImg)
--m_silentCall;if($.active<0)
$.active=0;if($.active-m_silentCall<=0&&self.isBusy&&m_manualBusy==0){self.isBusy=0;var tv=new Date()-m_tmBusy;m_tmBusy=0;console.log("idle after "+tv+"ms");self.hideLoading();}});}
function defAjaxErrProc(xhr,textStatus,e)
{var ctx=this.ctx_||{};ctx.status=xhr.status;ctx.statusText=xhr.statusText;if(xhr.status==0&&!ctx.noex){self.app_alert("连不上服务器了，是不是网络连接不给力？","e");}
else if(this.handleHttpError){var data=xhr.responseText;var rv=defDataProc.call(this,data);if(rv!==RV_ABORT)
this.success&&this.success(rv);return;}
else if(!ctx.noex){self.app_alert("操作失败: 服务器错误. status="+xhr.status+"-"+xhr.statusText,"e");}
leaveWaiting(ctx);}
self.defDataProc=defDataProc;function defDataProc(rv)
{var ctx=this.ctx_||{};var ext=ctx.ext;if(this.xhr_&&(ext==null||ext=="default")){var val=this.xhr_.getResponseHeader("X-Daca-Server-Rev");if(val&&g_data.serverRev!=val){if(g_data.serverRev){mCommon.reloadSite();}
console.log("Server Revision: "+val);g_data.serverRev=val;}
var modeStr;val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Test-Mode"));if(g_data.testMode!=val){g_data.testMode=val;if(g_data.testMode)
modeStr="测试模式";}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Mock-Mode"));if(g_data.mockMode!=val){g_data.mockMode=val;if(g_data.mockMode)
modeStr="测试模式+模拟模式";}
if(modeStr)
self.app_alert(modeStr,{timeoutInterval:2000});}
try{if(rv!==""&&typeof(rv)=="string")
rv=$.parseJSON(rv);}
catch(e)
{leaveWaiting(ctx);var msg="服务器数据错误。";self.app_alert(msg);ctx.dfd.reject.call(this,msg);return;}
if(ctx.tm){ctx.tv=new Date()-ctx.tm;}
ctx.ret=rv;leaveWaiting(ctx);if(ext){var filter=self.callSvrExt[ext]&&self.callSvrExt[ext].dataFilter;if(filter){var ret=filter.call(this,rv);if(ret==null||ret===false)
self.lastError=ctx;return ret;}}
if(rv&&$.isArray(rv)&&rv.length>=2&&typeof rv[0]=="number"){var that=this;if(rv[0]==0){ctx.dfd&&setTimeout(function(){ctx.dfd.resolve.call(that,rv[1]);});return rv[1];}
ctx.dfd&&setTimeout(function(){ctx.dfd.reject.call(that,rv[1]);});if(this.noex)
{this.lastError=rv;self.lastError=ctx;return false;}
if(rv[0]==E_NOAUTH){if(self.tryAutoLogin()){$.ajax(this);}
return RV_ABORT;}
else if(rv[0]==E_AUTHFAIL){var errmsg=rv[1]||"验证失败，请检查输入是否正确!";self.app_alert(errmsg,"e");return RV_ABORT;}
else if(rv[0]==E_ABORT){console.log("!!! abort call");return RV_ABORT;}
logError();self.app_alert("操作失败："+rv[1],"e");}
else{logError();self.app_alert("服务器通讯协议异常!","e");}
return RV_ABORT;function logError()
{self.lastError=ctx;console.log("failed call");console.log(ctx);}}
self.getBaseUrl=getBaseUrl;function getBaseUrl()
{return self.options.serverUrl.replace(/\/[^\/]+$/,'/');}
self.makeUrl=makeUrl;function makeUrl(action,params)
{var ext;if($.isArray(action)){if(window.MUI){ext=action[1];action=action[0];}
else{ext="default";action=action[0]+"."+action[1];}}
else{var m=action.match(/^(\w+):(\w.*)/);if(m){ext=m[1];action=m[2];}
else{ext="default";}}
if(action.makeUrl||/^http/.test(action)){if(params==null)
return action;if(action.makeUrl)
return makeUrl(action.action,$.extend({},action.params,params));var url=mCommon.appendParam(action,$.param(params));return makeUrlObj(url);}
if(params==null)
params={};var url;var fnMakeUrl=self.callSvrExt[ext]&&self.callSvrExt[ext].makeUrl;if(fnMakeUrl){url=fnMakeUrl(action,params);}
else if(url=self.options.moduleExt["callSvr"](action)){}
else if(action[0]!='.'&&action.indexOf(".php")<0)
{var opt=self.options;var usePathInfo=!opt.serverUrlAc;if(usePathInfo){if(opt.serverUrl.slice(-1)=='/')
url=opt.serverUrl+action;else
url=opt.serverUrl+"/"+action;}
else{url=opt.serverUrl;params[opt.serverUrlAc]=action;}}
else{if(location.protocol=="file:"){url=getBaseUrl()+action;}
else
url=action;}
if(window.g_cordova){if(m_appVer===undefined)
{var platform="n";if(mCommon.isAndroid()){platform="a";}
else if(mCommon.isIOS()){platform="i";}
m_appVer=platform+"/"+g_cordova;}
params._ver=m_appVer;}
if(self.options.appName)
params._app=self.options.appName;if(g_args._debug)
params._debug=g_args._debug;var ret=mCommon.appendParam(url,$.param(params));return makeUrlObj(ret);function makeUrlObj(url)
{var o=new String(url);o.makeUrl=true;if(action.makeUrl){o.action=action.action;o.params=$.extend({},action.params,params);}
else{o.action=action;o.params=params;}
return o;}}
self.callSvr=callSvr;self.callSvrExt={};function callSvr(ac,params,fn,postParams,userOptions)
{if($.isFunction(params)){userOptions=postParams;postParams=fn;fn=params;params=null;}
mCommon.assert(ac!=null,"*** bad param `ac`");var ext=null;var ac0=ac.action||ac;var m;if($.isArray(ac)){mCommon.assert(ac.length==2,"*** bad ac format, require [ac, ext]");ext=ac[1];if(ext!='default')
ac0=ext+':'+ac[0];else
ac0=ac[0];}
else if(m=ac.match(/^(\w+):(\w.*)/)){ext=m[1];}
else if(self.callSvrExt['default']){ext='default';}
var isSyncCall=(userOptions&&userOptions.async==false);if(m_curBatch&&!isSyncCall)
{return m_curBatch.addCall({ac:ac,get:params,post:postParams},fn,userOptions);}
var url=makeUrl(ac,params);var ctx={ac:ac0,tm:new Date()};if(userOptions&&userOptions.noLoadingImg)
ctx.noLoadingImg=1;if(userOptions&&userOptions.noex)
ctx.noex=1;if(ext){ctx.ext=ext;}
ctx.dfd=$.Deferred();if(self.mockData&&self.mockData[ac0]){ctx.isMock=true;ctx.getMockData=function(){var d=self.mockData[ac0];var param1=$.extend({},url.params);var postParam1=$.extend({},postParams);if($.isFunction(d)){d=d(param1,postParam1);}
if(self.options.logAction)
console.log({ac:ac0,ret:d,params:param1,postParams:postParam1,userOptions:userOptions});return d;}}
enterWaiting(ctx);var callType="call";if(isSyncCall)
callType+="-sync";if(ctx.isMock)
callType+="-mock";var method=(postParams==null?'GET':'POST');var opt={dataType:'text',url:url,data:postParams,type:method,success:fn,xhrFields:{withCredentials:true},ctx_:ctx};if(window.FormData&&postParams instanceof FormData){opt.processData=false;opt.contentType=false;}
$.extend(opt,userOptions);if(ext&&self.callSvrExt[ext].beforeSend){self.callSvrExt[ext].beforeSend(opt);}
if(!opt.contentType&&opt.data){var useJson=$.isArray(opt.data);if(!useJson&&$.isPlainObject(opt.data)){$.each(opt.data,function(i,e){if(typeof(e)=="object"){useJson=true;return false;}})}
if(useJson){opt.contentType="application/json";}}
var isJson=opt.contentType&&opt.contentType.indexOf("/json")>0;if(isJson&&opt.data instanceof Object)
opt.data=JSON.stringify(opt.data);console.log(callType+": "+opt.type+" "+ac0);if(ctx.isMock)
return callSvrMock(opt,isSyncCall);$.ajax(opt);return ctx.dfd;}
function callSvrMock(opt,isSyncCall)
{var dfd_=opt.ctx_.dfd;var opt_=opt;if(isSyncCall){callSvrMock1();}
else{setTimeout(callSvrMock1,self.options.mockDelay);}
return dfd_;function callSvrMock1()
{var data=opt_.ctx_.getMockData();if(typeof(data)!="string")
data=JSON.stringify(data);var rv=defDataProc.call(opt_,data);if(rv!==RV_ABORT)
{opt_.success&&opt_.success(rv);return;}
self.app_abort();}}
self.callSvrSync=callSvrSync;function callSvrSync(ac,params,fn,postParams,userOptions)
{var ret;if($.isFunction(params)){userOptions=postParams;postParams=fn;fn=params;params=null;}
userOptions=$.extend({async:false},userOptions);var dfd=callSvr(ac,params,function(data){ret=data;fn&&fn.call(this,data);},postParams,userOptions);return ret;}
self.setupCallSvrViaForm=setupCallSvrViaForm;function setupCallSvrViaForm($form,$iframe,url,fn,callOpt)
{$form.attr("action",url);$iframe.on("load",function(){var data=this.contentDocument.body.innerText;if(data=="")
return;var rv=defDataProc.call(callOpt,data);if(rv===RV_ABORT)
self.app_abort();fn(rv);});}
self.batchCall=batchCall;function batchCall(opt)
{mCommon.assert(m_curBatch==null,"*** multiple batch call!");this.opt_=opt;this.calls_=[];this.callOpts_=[];if(!self.disableBatch)
m_curBatch=this;}
batchCall.prototype={addCall:function(call0,fn,opt0){var call=$.extend({},call0);var opt=$.extend({},opt0);if(opt.ref){call.ref=opt.ref;}
if(call.ac&&call.ac.makeUrl){call.get=$.extend({},call.ac.params,call.get);call.ac=call.ac.action;}
this.calls_.push(call);var callOpt={fn:fn,opt:opt,dfd:$.Deferred()};this.callOpts_.push(callOpt);return callOpt.dfd;},deferred:function(){return this.dfd_;},commit:function(){if(m_curBatch==null)
return;m_curBatch=null;if(this.calls_.length<1){console.log("!!! warning: batch has "+this.calls_.length+" calls!");return;}
if(this.calls_.length==1){var call=this.calls_[0];var callOpt=this.callOpts_[0];var dfd=callSvr(call.ac,call.get,callOpt.fn,call.post,callOpt.opt);dfd.then(function(data){callOpt.dfd.resolve(data);});return;}
var batch_=this;var postData=this.calls_;callSvr("batch",this.opt_,api_batch,postData,{contentType:"application/json; charset=utf-8"});function api_batch(data)
{var ajaxCtx_=this;$.each(data,function(i,e){var callOpt=batch_.callOpts_[i];var extendCtx=false;if(callOpt.opt&&!$.isEmptyObject(callOpt.opt)){extendCtx=true;$.extend(ajaxCtx_,callOpt.opt);}
var data1=defDataProc.call(ajaxCtx_,e);if(data1!==RV_ABORT){if(callOpt.fn){callOpt.fn.call(ajaxCtx_,data1);}
callOpt.dfd.resolve(data1);}
if(extendCtx){$.each(Object.keys(callOpt.opt),function(){ajaxCtx_[this]=null;});}});}},cancel:function(){m_curBatch=null;}}
self.useBatchCall=useBatchCall;function useBatchCall(opt,tv)
{if(self.disableBatch)
return;if(m_curBatch!=null)
return;tv=tv||0;var batch=new self.batchCall(opt);setTimeout(function(){batch.commit();},tv);}}
jdModule("jdcloud.wui",JdcloudWui);function JdcloudWui()
{var self=this;var mCommon=jdModule("jdcloud.common");JdcloudApp.call(self);JdcloudCall.call(self);self.isBusy=false;window.g_args={};window.g_data={};window.BASE_URL="../";window.FormMode={forAdd:'A',forSet:'S',forLink:'S',forFind:'F',forDel:'D'};self.options={title:"客户端",appName:"user",onShowLogin:function(){throw"NotImplemented";},pageHome:"pageHome",pageFolder:"page",serverUrl:"./",logAction:false,PAGE_SZ:20,manualSplash:false,mockDelay:50,moduleExt:{showPage:$.noop,callSvr:$.noop}};function parseArgs()
{if(location.search){g_args=mCommon.parseQuery(location.search.substr(1));}}
parseArgs();self.app_alert=app_alert;function app_alert(msg)
{console.log("app_alert",msg);}
function tokenName()
{var name="token";if(self.options.appName)
name+="_"+self.options.appName;return name;}
self.saveLoginToken=saveLoginToken;function saveLoginToken(data)
{if(data._token)
{mCommon.setStorage(tokenName(),data._token);}}
self.loadLoginToken=loadLoginToken;function loadLoginToken()
{return mCommon.getStorage(tokenName());}
self.deleteLoginToken=deleteLoginToken;function deleteLoginToken()
{mCommon.delStorage(tokenName());}
self.tryAutoLogin=tryAutoLogin;function tryAutoLogin(onHandleLogin,reuseCmd)
{var ok=false;var ajaxOpt={async:false,noex:true};function handleAutoLogin(data)
{if(data===false)
return;if(onHandleLogin)
onHandleLogin.call(this,data);ok=true;}
if(reuseCmd!=null){self.callSvr(reuseCmd,handleAutoLogin,null,ajaxOpt);}
if(ok)
return ok;var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",handleAutoLogin,postData,ajaxOpt);}
if(ok)
return ok;self.options.onShowLogin();return ok;}
self.tryAutoLoginAsync=tryAutoLoginAsync;function tryAutoLoginAsync(onHandleLogin,reuseCmd)
{var ajaxOpt={noex:true};var dfd=$.Deferred();function success(data){if(onHandleLogin)
onHandleLogin.call(this,data);dfd.resolve();}
function fail(){dfd.reject();self.options.onShowLogin();}
if(reuseCmd!=null){self.callSvr(reuseCmd,function(data){if(data===false){loginByToken()
return;}
success(data);},null,ajaxOpt);}
else{loginByToken();}
function loginByToken()
{var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",function(data){if(data===false){fail();return;}
success(data);},postData,ajaxOpt);}
else{fail();}}
return dfd.promise();}
self.handleLogin=handleLogin;function handleLogin(data)
{g_data.userInfo=data;if(g_args.autoLogin||/android|ipad|iphone/i.test(navigator.userAgent))
saveLoginToken(data);self.showPage(self.options.pageHome);if(location.hash.startsWith("#page")){WUI.showPage(location.hash.replace('#',''));}}
self.initClient=initClient;var plugins_={};function initClient()
{self.callSvrSync('initClient',function(data){g_data.initClient=data;plugins_=data.plugins||{};$.each(plugins_,function(k,e){if(e.js){var js=BASE_URL+'plugin/'+k+'/'+e.js;mCommon.loadScript(js,{async:true});}});});}
window.Plugins={exists:function(pname){return plugins_[pname]!==undefined;},list:function(){return plugins_;}};self.setApp=setApp;function setApp(app)
{$.extend(self.options,app);}
self.logout=logout;function logout(dontReload)
{deleteLoginToken();g_data.userInfo=null;return self.callSvr("logout",function(data){if(!dontReload)
mCommon.reloadSite();});}
self.showLoading=showLoading;function showLoading()
{console.log('loading');}
self.hideLoading=hideLoading;function hideLoading()
{console.log('hide loading');}}
(function(){var mCommon=jdModule("jdcloud.common");window.WUI=jdModule("jdcloud.wui");$.extend(WUI,mCommon);$.each(["intSort","numberSort","callSvr","callSvrSync","app_alert","app_confirm","app_show",],function(){window[this]=WUI[this];});})();